<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 0;
      background: #f9fafb;
      height: 100vh;
      overflow: hidden;
    }
    
    /* Auth Screen */
    .auth-screen {
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }
    .auth-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 8px;
    }
    .auth-header p {
      font-size: 14px;
      color: #6b7280;
      line-height: 1.5;
    }
    .input-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #3b82f6;
    }
    button {
      width: 100%;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }
    .btn-primary {
      background: #3b82f6;
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      background: #2563eb;
    }
    .btn-primary:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
      margin-top: 8px;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    
    /* Main Screen */
    .main-screen {
      display: none;
      height: 100vh;
      flex-direction: column;
    }
    .header {
      background: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h2 {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
    }
    .user-info {
      font-size: 12px;
      color: #6b7280;
    }
    .logout-btn {
      background: none;
      border: none;
      color: #ef4444;
      font-size: 12px;
      padding: 4px 8px;
      cursor: pointer;
      border-radius: 4px;
      width: auto;
    }
    .logout-btn:hover {
      background: #fef2f2;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    .tab {
      flex: 1;
      padding: 12px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: #6b7280;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
    }
    .tab.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
    }
    .tab:hover {
      color: #374151;
    }
    
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }
    
    .item-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-card {
      background: white;
      border: 1.5px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .item-card:hover {
      border-color: #3b82f6;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
    }
    .item-card h3 {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }
    .item-card p {
      font-size: 12px;
      color: #6b7280;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #9ca3af;
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .loading {
      text-align: center;
      padding: 48px 24px;
      color: #6b7280;
    }
    
    .status {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin: 16px;
      display: none;
    }
    .status.success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    .status.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="authScreen">
    <div class="auth-header">
      <h1>üé® UX Probe</h1>
      <p>Sign in to import your research data into Figma</p>
    </div>
    
    <div class="input-group">
      <label for="email">Email</label>
      <input type="email" id="email" placeholder="your@email.com" />
    </div>
    
    <div class="input-group">
      <label for="password">Password</label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
    </div>
    
    <button class="btn-primary" id="loginBtn">Sign In</button>
    <button class="btn-secondary" id="cancelBtn">Cancel</button>
  </div>

  <!-- Main Screen -->
  <div class="main-screen" id="mainScreen">
    <div class="header">
      <h2>Your Research Data</h2>
      <div>
        <span class="user-info" id="userEmail"></span>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" data-tab="journeys">User Journeys</button>
      <button class="tab" data-tab="mindmaps">Mind Maps</button>
      <button class="tab" data-tab="ia">Info Architecture</button>
    </div>
    
    <div class="content">
      <div class="tab-panel active" id="journeysPanel">
        <div class="loading">Loading...</div>
      </div>
      <div class="tab-panel" id="mindmapsPanel">
        <div class="loading">Loading...</div>
      </div>
      <div class="tab-panel" id="iaPanel">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <div class="status" id="status"></div>

  <script>
    const API_URL = 'https://vaeyjsqalzcdejwsvoql.supabase.co';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhZXlqc3FhbHpjZGVqd3N2b3FsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDYwMDIsImV4cCI6MjA3NjE4MjAwMn0.jThP8cy8deaDkQZlTz6Bb0C1DU6praULawIej2vBghA';
    
    let accessToken = null;
    let userEmail = null;

    // DOM Elements
    const authScreen = document.getElementById('authScreen');
    const mainScreen = document.getElementById('mainScreen');
    const loginBtn = document.getElementById('loginBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const userEmailSpan = document.getElementById('userEmail');
    const tabs = document.querySelectorAll('.tab');
    const status = document.getElementById('status');

    // Event Listeners
    loginBtn.addEventListener('click', handleLogin);
    cancelBtn.addEventListener('click', () => parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*'));
    logoutBtn.addEventListener('click', handleLogout);
    
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        switchTab(tabName);
      });
    });

    emailInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') passwordInput.focus();
    });
    
    passwordInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    async function handleLogin() {
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        showStatus('Please enter email and password', 'error');
        return;
      }

      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';

      try {
        const response = await fetch(`${API_URL}/auth/v1/token?grant_type=password`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': ANON_KEY
          },
          body: JSON.stringify({ email, password })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error_description || 'Login failed');
        }

        accessToken = data.access_token;
        userEmail = email;
        
        showMainScreen();
        await loadAllData();
      } catch (error) {
        showStatus('Login failed: ' + error.message, 'error');
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    }

    function handleLogout() {
      accessToken = null;
      userEmail = null;
      emailInput.value = '';
      passwordInput.value = '';
      authScreen.classList.remove('hidden');
      mainScreen.style.display = 'none';
    }

    function showMainScreen() {
      authScreen.classList.add('hidden');
      mainScreen.style.display = 'flex';
      userEmailSpan.textContent = userEmail;
    }

    function switchTab(tabName) {
      tabs.forEach(t => t.classList.remove('active'));
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(`${tabName}Panel`).classList.add('active');
    }

    async function loadAllData() {
      await Promise.all([
        loadJourneys(),
        loadMindMaps(),
        loadIA()
      ]);
    }

    async function loadJourneys() {
      const panel = document.getElementById('journeysPanel');
      try {
        const response = await fetch(`${API_URL}/functions/v1/get-figma-user-journey-maps`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'apikey': ANON_KEY
          }
        });

        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || 'Failed to load');

        renderItems(panel, result.data, 'user_journey_map');
      } catch (error) {
        panel.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error: ${error.message}</p></div>`;
      }
    }

    async function loadMindMaps() {
      const panel = document.getElementById('mindmapsPanel');
      try {
        const response = await fetch(`${API_URL}/functions/v1/get-figma-mind-maps`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'apikey': ANON_KEY
          }
        });

        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || 'Failed to load');

        renderItems(panel, result.data, 'mind_map');
      } catch (error) {
        panel.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error: ${error.message}</p></div>`;
      }
    }

    async function loadIA() {
      const panel = document.getElementById('iaPanel');
      try {
        const response = await fetch(`${API_URL}/functions/v1/get-figma-information-architectures`, {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'apikey': ANON_KEY
          }
        });

        const result = await response.json();
        
        if (!response.ok) throw new Error(result.error || 'Failed to load');

        renderItems(panel, result.data, 'information_architecture');
      } catch (error) {
        panel.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><p>Error: ${error.message}</p></div>`;
      }
    }

    function renderItems(panel, items, type) {
      if (!items || items.length === 0) {
        panel.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üì≠</div><p>No ${type.replace('_', ' ')}s found</p></div>`;
        return;
      }

      const itemList = document.createElement('div');
      itemList.className = 'item-list';

      items.forEach(item => {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
          <h3>${escapeHtml(item.title)}</h3>
          <p>${new Date(item.created_at).toLocaleDateString()}</p>
        `;
        
        card.addEventListener('click', () => {
          importItem(item, type);
        });
        
        itemList.appendChild(card);
      });

      panel.innerHTML = '';
      panel.appendChild(itemList);
    }

    function importItem(item, type) {
      let exportData = null;

      if (type === 'user_journey_map') {
        exportData = {
          exportType: 'user_journey_map',
          data: item.journey_data
        };
      } else if (type === 'mind_map') {
        exportData = {
          exportType: 'mind_map',
          data: transformMindMapData(item.content)
        };
      } else if (type === 'information_architecture') {
        exportData = {
          exportType: 'information_architecture',
          data: transformIAData(item.structure)
        };
      }

      parent.postMessage({ 
        pluginMessage: { 
          type: 'import-data', 
          data: JSON.stringify(exportData)
        } 
      }, '*');
    }

    function transformMindMapData(content) {
      const branches = [];
      const rootNode = content.nodes.find(n => n.id === 'root');
      const rootChildren = content.nodes.filter(n => n.parentId === 'root');

      rootChildren.forEach(child => {
        const subBranches = content.nodes
          .filter(n => n.parentId === child.id)
          .map(n => n.label);

        branches.push({
          topic: child.label,
          subBranches: subBranches
        });
      });

      return {
        title: content.title || rootNode.label,
        centralTopic: rootNode.label,
        branches: branches
      };
    }

    function transformIAData(structure) {
      function buildHierarchy(nodes, parentId = null) {
        return nodes
          .filter(n => n.parentId === parentId)
          .map(node => ({
            name: node.label,
            children: buildHierarchy(nodes, node.id)
          }));
      }

      return {
        name: structure.title,
        sections: buildHierarchy(structure.nodes, null)
      };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showStatus(message, type) {
      status.textContent = message;
      status.className = `status ${type}`;
      status.style.display = 'block';
      
      setTimeout(() => {
        status.style.display = 'none';
      }, 5000);
    }

    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'import-success') {
        showStatus('‚úì Successfully imported into Figma!', 'success');
      } else if (msg.type === 'import-error') {
        showStatus(`‚úó Import failed: ${msg.error}`, 'error');
      }
    };
  </script>
</body>
</html>